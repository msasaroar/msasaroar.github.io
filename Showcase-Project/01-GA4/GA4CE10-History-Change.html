<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History Change Event Demo</title>
  <!-- Google Tag Manager -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MB72WSHR');
  </script>
  <!-- End Google Tag Manager -->
  <style>
    header {
      background-color: green;
      color: black;
      font-weight: bold;
      font-size: 35px;
      text-align: center;
      padding: 20px 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
    }
    body {
      background-color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .home-button {
      position: absolute;
      border-radius: 8px;
      font-size: 16px;
      left: 15px;
      top: 10px;
      background-color: orange;
      color: blue;
      padding: 15px 30px;
      text-decoration: none;
      border: none;
      font-weight: bold;
      cursor: pointer;
      border: 5px solid darkgreen;
      border-radius: 6px;
      z-index: 1001;
    }
    .home-button:hover {
      background-color: blue;
      color: orange;
    }
    main {
      padding: 100px 20px 0;
      max-width: 800px;
      margin: auto;
      text-align: center;
    }
    button {
      background-color: orange;
      color: blue;
      padding: 15px 30px;
      font-size: 18px;
      border: none;
      cursor: pointer;
      border-radius: 8px;
      margin: 10px;
      font-weight: bold;
    }
    button:hover {
      background-color: blue;
      color: orange;
    }
    #output {
      margin-top: 20px;
      font-size: 18px;
      color: darkgreen;
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MB72WSHR"
    height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
  <!-- End Google Tag Manager (noscript) -->

  <header>
    History Change Event Demo
  </header>

  <a href="index.html" class="home-button">Home</a>

  <main>

    <section>
      <h2>What is a "History Change Event"?</h2>
      <p>
        A <strong>History Change Event</strong> occurs when the browser's URL is changed using JavaScript without reloading the page. This is common in Single Page Applications (SPAs), where internal navigation happens dynamically using methods like <code>history.pushState()</code> or <code>history.replaceState()</code>.
      </p>
      <p>
        These changes donâ€™t cause full page reloads, so traditional pageview tracking won't detect them. Tools like Google Tag Manager use a <strong>History Change Trigger</strong> to listen for these events and fire tags accordingly, such as virtual page views in GA4.
      </p>
      <p><strong>Example:</strong> When you click the button below, the URL will change (simulating navigation), but the page won't reload.</p>
    </section>

    <h2>Test History Changes</h2>
    <button onclick="pushStateExample()">Push State</button>
    <button onclick="replaceStateExample()">Replace State</button>
    <button onclick="window.history.back()">Go Back</button>
    <button onclick="window.history.forward()">Go Forward</button>

    <div id="output">Current URL Path: <span id="pathDisplay"></span></div>
  </main>

  <script>
    // Custom wrapper to track history changes and notify GTM
    function overrideHistoryMethods() {
      const pushState = history.pushState;
      const replaceState = history.replaceState;

      history.pushState = function(state, title, url) {
        const result = pushState.apply(this, arguments);
        window.dispatchEvent(new Event('pushstate'));
        window.dispatchEvent(new Event('locationchange'));
        return result;
      };

      history.replaceState = function(state, title, url) {
        const result = replaceState.apply(this, arguments);
        window.dispatchEvent(new Event('replacestate'));
        window.dispatchEvent(new Event('locationchange'));
        return result;
      };

      window.addEventListener('popstate', () => {
        window.dispatchEvent(new Event('locationchange'));
      });
    }

    overrideHistoryMethods();

    // For display purpose
    function updatePathDisplay() {
      document.getElementById('pathDisplay').textContent = window.location.pathname;
    }

    window.addEventListener('locationchange', () => {
      console.log("History Changed:", window.location.pathname);
      updatePathDisplay();
      // Optional: Push to dataLayer for GTM trigger
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        event: 'history_change',
        newPath: window.location.pathname
      });
    });

    function pushStateExample() {
      const newPath = "/new-page-" + Math.floor(Math.random() * 100);
      history.pushState({}, "", newPath);
    }

    function replaceStateExample() {
      const newPath = "/replaced-page-" + Math.floor(Math.random() * 100);
      history.replaceState({}, "", newPath);
    }

    // Initial path display
    updatePathDisplay();
  </script>
</body>
</html>
